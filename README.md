# stack-usage-db

Generate a single file containing GCC `-fstack-usage` information for
all function symbols defined in an ELF file.

## Motivation

Recent versions of GCC allow generating per-function stack usage
information using the `-fstack-usage` compiler flag. Unfortunately, gcc
stores this information on a per compilation-unit basis. This creates
issues if one considers a linked ELF file and wants to determine the
stack usage of a given function symbol in this ELF file. For example,
static function may be declared with the same name across different
compilation units.

## Approach

To resolve the problem outlined above. This tool concatenates multiple
`-fstack-usage` files into a single file/database. The tool iterates
over a given ELF file and extracts the source line information for each
function symbol. The source file path is then passed to a user-supplied
script which returns the stack-usage path for a given source file path.
The stack-usage file is then parsed and the function symbol address is
associated with the stack size for this function as determined by the
stack-usage file.

## Usage

A sample script is provided in `convert.sh`. This tool requires
`libdwfl` from [elfutils](https://sourceware.org/elfutils/) and
`addr2line` from [binutils](https://www.gnu.org/software/binutils/). If
these are installed, compile as follows:

	$ make

Afterwards, compile the example and run `stack-usage-db` as follows:
Afterwards, execute as follows:

	$ make -C ./example
	$ ./stack-usage-db ./example/main ./convert.sh

Which will generate the following tab-separated output:

	1009c	get_mtime	32
	10118	get_mtime	16
	10074	main	32
	10134	myfunc2	48
	100e4	myfunc1	32

## Limitations

### Aliases

The utility is presently not capable of correctly detecting symbol
aliases. For example, consider the following two symbols:

	183: 20401470   670 FUNC    GLOBAL DEFAULT    2 _vfiprintf_r
	197: 20401470   670 FUNC    GLOBAL DEFAULT    2 _vfprintf_r

In this case, there is no way for `stack-usage-db` to determine whether
`_vfiprintf_r` is an alias for `_vfprintf_r` or vice versa. This is
important, as only one of these symbols will be recorded in the
corresponding `-fstack-usage` file. Presently, a warning will be output
by `stack-usage-db` upon encountering aliases. This warning can be
ignored as long as the stack-usage information for the original symbol,
which uses the same text segment address, was found successfully.

### Assembly Files

The `-fstack-usage` GCC flag only works for C/C++ source code. For files
written in assembly language, stack-usage information is not
automatically generated by GCC itself. As such, the generated database
does not contain stack usage information for these files. It is,
however, possible to add stack-usage information for symbols from
assembly files manually to the database.

## Acknowledgements

This work was supported in part by the German Federal Ministry of
Education and Research (BMBF) within the project Scale4Edge under
contract no. 16ME0127 and within the project VerSys under contract
no. 01IW19001.
